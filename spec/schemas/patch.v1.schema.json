{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "bdir://schemas/patch.v1",
  "title": "BDIR Patch v1",
  "type": "object",
  "required": ["v", "ops"],
  "additionalProperties": false,
  "properties": {
    "v": { "type": "integer", "const": 1 },
    "h": { "type": "string", "minLength": 1 },
    "ha": { "type": "string", "minLength": 1 },
    "ops": {
      "type": "array",
      "items": { "$ref": "#/definitions/op" }
    }
  },
  "definitions": {
    "op": {
      "type": "object",
      "required": ["op"],
      "additionalProperties": false,
      "properties": {
        "op": {
          "type": "string",
          "enum": ["replace", "delete", "insert_after", "suggest"]
        },
        "block_id": { "type": "string", "minLength": 1 },
        "blockId": { "type": "string", "minLength": 1 },
        "before": { "type": "string" },
        "after": { "type": "string" },
        "occurrence": {
          "description": "1-indexed occurrence selector. Legacy delete-only string values ('first'/'all') are accepted for backwards compatibility.",
          "anyOf": [
            { "type": "integer", "minimum": 1 },
            { "type": "string", "enum": ["first", "all"] }
          ]
        },
        "content": { "type": "string" },
        "new_block_id": { "type": "string", "minLength": 1 },
        "newBlockId": { "type": "string", "minLength": 1 },
        "kind_code": { "type": "string", "minLength": 1 },
        "kindCode": { "type": "string", "minLength": 1 },
        "text": { "type": "string" },
        "severity": { "type": "string", "enum": ["low", "medium", "high"] },
        "message": { "type": "string" }
      },
      "allOf": [
        {
          "oneOf": [
            { "required": ["block_id"], "not": { "required": ["blockId"] } },
            { "required": ["blockId"], "not": { "required": ["block_id"] } }
          ]
        },
        {
          "if": { "properties": { "op": { "const": "replace" } } },
          "then": {
            "required": ["before", "after"],
            "properties": {
              "occurrence": { "type": "integer", "minimum": 1 }
            }
          }
        },
        {
          "if": { "properties": { "op": { "const": "delete" } } },
          "then": { "required": ["before"] }
        },
        {
          "if": { "properties": { "op": { "const": "insert_after" } } },
          "then": {
            "allOf": [
              {
                "oneOf": [
                  { "required": ["new_block_id"], "not": { "required": ["newBlockId"] } },
                  { "required": ["newBlockId"], "not": { "required": ["new_block_id"] } }
                ]
              },
              {
                "oneOf": [
                  { "required": ["kind_code"], "not": { "required": ["kindCode"] } },
                  { "required": ["kindCode"], "not": { "required": ["kind_code"] } }
                ]
              },
              {
                "oneOf": [
                  { "required": ["text"], "not": { "required": ["content"] } },
                  { "required": ["content"], "not": { "required": ["text"] } }
                ]
              }
            ],
            "not": {
              "anyOf": [
                { "required": ["before"] },
                { "required": ["after"] },
                { "required": ["message"] },
                { "required": ["occurrence"] },
                { "required": ["severity"] }
              ]
            }
          }
        },
        {
          "if": { "properties": { "op": { "const": "suggest" } } },
          "then": {
            "required": ["message"],
            "not": {
              "anyOf": [
                { "required": ["before"] },
                { "required": ["after"] },
                { "required": ["content"] },
                { "required": ["text"] },
                { "required": ["new_block_id"] },
                { "required": ["newBlockId"] },
                { "required": ["kind_code"] },
                { "required": ["kindCode"] },
                { "required": ["occurrence"] }
              ]
            }
          }
        }
      ]
    }
  }
}
